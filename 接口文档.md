# Memcontext Service API 
### 文档版本: 1.0.0
### 最后更新: 
### 描述: Memcontext 是一个智能记忆增强服务，提供长短期记忆管理、多模态内容（视频/图像）解析注入以及用户画像分析能力。目录基础说明会话管理初始化记忆系统清除记忆对话交互发送对话导入历史对话多模态记忆注入添加多模态记忆流式添加多模态记忆从缓存导入记忆状态查询获取记忆状态高级分析触发整合分析人格画像分析错误处理
## 1. 基础说明
#### Base URL: http://localhost:5019 (默认)
#### 数据格式: 请求与响应均主要使用 JSON 格式。
#### 鉴权与会话:系统使用 Flask Session (Cookie) 进行会话管理。
#### 重要: 必须先调用 POST /init_memory 接口。后续所有接口调用必须在请求头中携带初始化时返回的 Cookie，否则会返回 400 Error: Memory system not initialized。

## 2. 会话管理初始化记忆系统

### 2.1 系统初始化
#### **POST /init_memory**
初始化一个新的用户记忆上下文系统。这是交互的第一步。请求参数 (JSON)参数名类型必填说明user_idstring是用户唯一标识符file_storage_base_pathstring否文件存储根路径，默认为服务端的项目根目录
#### 请求示例
```json
{
  "user_id": "user_1001",
  "file_storage_base_path": "/app/data"
}
```

#### 响应示例
```json
{
  "success": true,
  "session_id": "7f8a9b...",
  "user_id": "user_1001",
  "assistant_id": "assistant_user_1001",
  "model": "doubao-seed-1-6-flash-250828",
  "embedding_provider": "doubao"
}
```
### 2.2 清除记忆
#### **POST /clear_memory**
危险操作。彻底清空当前用户的所有记忆数据（包括磁盘上的 JSON 文件），并重置内存实例。

#### 响应示例
```json
{
  "success": true,
  "message": "All memories cleared successfully"
}
```
## 3. 对话交互发送对话
### 3.1 发送用户消息
#### **POST /chat**
系统会自动检索长/中/短期记忆，生成回复，并将本轮对话存入短期记忆。请求参数 (JSON)参数名类型必填说明messagestring是用户输入的文本内容

#### 响应示例
```json
{
  "response": "你好！根据之前的记忆，你提到过喜欢科幻电影。",
  "timestamp": "2026-01-21 10:30:00"
}
```
### 3.2 导入历史对话
#### **POST /import_conversations**
批量导入外部的历史对话记录到记忆系统中。请求参数 (JSON)参数名类型必填说明conversationslist是对话对象列表对话对象结构字段类型说明user_inputstring用户输入agent_responsestring助手回复timestampstring时间戳 (可选，默认当前时间)

#### 请求示例
```json
{
  "conversations": [
    {
      "user_input": "我叫张三",
      "agent_response": "你好张三",
      "timestamp": "2025-01-01 10:00:00"
    },
    {
      "user_input": "我住在北京",
      "agent_response": "记住了",
      "timestamp": "2025-01-01 10:05:00"
    }
  ]
}
```

#### 响应示例
```json
{
  "success": true,
  "imported_count": 2,
  "message": "Successfully imported 2 conversations"
}
```
## 4. 多模态记忆注入添加多模态记忆
### 4.1 处理视频或文件，将其转化为文本记忆片段存入系统
#### **POST /add_multimodal_memory**

支持直接上传或指定服务器路径。Header:Content-Type: application/json (指定路径模式)Content-Type: multipart/form-data (文件上传模式)请求参数说明指定路径模式 (JSON):file_path (string, 必填): 服务器本地的绝对文件路径。converter_type (string): 默认为 videorag (视频切片RAG)，也可选 video。agent_response (string): 助手对该文件的预设回复。converter_kwargs (object): 转换参数（如 chunk_size）。文件上传模式 (Form-Data):file: (Binary) 文件流。其他参数同上，作为 form 字段传递。

#### 请求示例 
```json
{
  "file_path": "/data/uploads/demo_video.mp4",
  "converter_type": "videorag",
  "agent_response": "我正在分析这个视频...",
  "converter_kwargs": {
    "language": "zh",
    "chunk_size": 30
  }
}
```

#### 响应示例
```json
{
  "success": true,
  "file_id": "a1b2c3d4...", 
  "ingested_rounds": 12,
  "storage_path": "/app/files/videos/a1b2c3d4/original.mp4",
  "timestamps": ["..."],
  "progress": [
    {"progress": 1.0, "message": "Done"}
  ]
}
```

### 4.2 流式添加多模态记忆
#### **POST /add_multimodal_memory_stream**
流式接口（SSE），用于实时获取大文件（如长视频）的处理进度。

#### 请求参数 
同 /add_multimodal_memory 的 JSON 模式。
#### 响应
text/event-stream 格式的事件流。
#### 事件数据
```json
{
"progress": 0.5,
"message": "Extracting audio..."},
 结束事件: {"done": true, "success": true, 
 ...
 }
 ```

### 4.3 从缓存导入
#### **POST /import_from_cache**
如果某文件之前已处理过（存在 temp_memory），可通过此接口根据 File ID 快速重新导入，跳过耗时的 AI 解析。

#### 请求参数 
```json
{
  "file_id": "a1b2c3d4..." // 文件的哈希 ID 或 storage ID
}
```

## 5. 记忆状态查询获取记忆状态
### 5.1 获取当前用户的完整记忆状态快照
#### **GET /memory_state**
获取当前用户的完整记忆状态快照，包含短期、中期和长期记忆详情。

#### 响应示例
```json
{
  "short_term": {
    "capacity": 7,
    "current_count": 1,
    "memories": [
      {
        "user_input": "你好",
        "agent_response": "你好",
        "timestamp": "...",
        "meta_data": {}
      }
    ]
  },
  "mid_term": {
    "capacity": 200,
    "current_count": 1,
    "sessions": [
      {
        "id": "session_001",
        "summary": "用户询问了关于Python编程的问题",
        "keywords": ["Python", "编程"],
        "heat": 12.5,
        "visit_count": 2,
        "page_count": 5
      }
    ],
    "heat_threshold": 10.0
  },
  "long_term": {
    "user_profile": "用户是一名软件工程师，对AI感兴趣。", 
    "user_knowledge": [
      "用户使用MacBook Pro",
      "用户住在上海"
    ],
    "assistant_knowledge": [
      "助手被设定为以简洁风格回答"
    ]
  }
}
```
## 6. 高级分析触发整合分析
### 6.1 记忆分析
#### **POST /trigger_analysis**
手动触发中期记忆（Mid-term）到长期记忆（Long-term）的整合分析。通常系统会根据记忆热度（Heat）自动触发，此接口用于测试或强制更新。
#### 响应示例
```json
{
  "success": true,
  "message": "Analysis triggered successfully"
}
```
### 6.2 人格画像分析
#### **POST /personality_analysis**
基于长期记忆中的用户画像文本，解析出结构化的人格维度数据（如大五人格、AI对齐维度、兴趣标签）。

#### 响应示例
```json
{
  "success": true,
  "personality_analysis": {
    "Psychological Model": [
      { "dimension": "Openness", "level": "High" },
      { "dimension": "Extraversion", "level": "Medium" }
    ],
    "AI Alignment Dimensions": [
      { "dimension": "Safety", "level": "High" }
    ],
    "Content Platform Interest Tags": [
      { "dimension": "Tech Interest", "level": "High" }
    ]
  }
}
```
## 7. 错误处理当请求处理失败时，接口会返回非 200 的 HTTP 状态码（如 400, 404, 500），并返回以下 JSON 结构：

```json
{
  "error": "User ID 是必需的。",
  "traceback": "Traceback (most recent call last): ..." // 仅在 Debug 模式下返回
}
```


## 8. 广告推荐接口
### POST /advertise
#### 接收用户的兴趣标签和ID，结合用户当前的短期对话记忆（Short-term Memory），利用 LLM进行语义分析，提取主题（Topics）和具体关键词（Keywords），并在广告库中进行匹配，返回个性化的推荐广告列表

#### 请求示例:
```json
{
    "user_id": "bjf",
    "interest_tag": ["technology","sports"]
}
```

#### 响应实例:
```json
{
    "success": true,
    "message": "Advertisement analysis completed.",
    "ads": [
            {
                "ad_id": "ad_002",
                "title": "智能健康手环 Pro",
                "description": "24小时心率监测，睡眠分析，你的健康管家。",
                "image_url": "https://example.com/band.jpg",
                "link_url": "https://example.com/prod/002",
                "keywords": ["手环", "健康", "心率", "跑步", "科技"],
                "topics": ["technology", "sports", "health"],
                "priority": 8
            },
            ......
          ]
}
```